import asyncio
import logging
from message_broker import MessageBroker
from ocr_module import OCRModule  # Import the OCR module here

class ModuleController:
    def __init__(self, message_broker: MessageBroker):
        self.message_broker = message_broker
        self.selected_video_topic = ""
        self.gaze_enabled = False
        self.latest_fixation_target = None
        self.logger = logging.getLogger(__name__)

    async def start(self):
        self.logger.info("ModuleController started")

        # Backend subscriptions
        await self.message_broker.subscribe("Backend/selected_video_topic_update", self.handle_selected_video_topic_update)
        await self.message_broker.subscribe("Backend/gaze_enabled_state_update", self.handle_gaze_enabled_state_update)
        await self.message_broker.subscribe("Backend/processing_mode_action", self.handle_processing_mode_action)

        # Video render subscriptions
        await self.message_broker.subscribe("VideoRenderer/fixation_target", self.handle_fixation_target)

        # OCR results subscription
        await self.message_broker.subscribe("OCRModule/ocr_results", self.handle_ocr_results)

    # Rest of the ModuleController code...

# Main execution function
async def main(enable_logging):
    try:
        # Set up logging
        if enable_logging:
            logging.basicConfig(level=logging.DEBUG)
        else:
            logging.basicConfig(level=logging.INFO)

        # Instantiate the message brokers and modules
        message_broker = MessageBroker(1024)

        module_controller = ModuleController(message_broker=message_broker)
        ocr_module = OCRModule(message_broker=message_broker)  # Instantiate the OCRModule

        # Start all modules
        await asyncio.gather(
            module_controller.start(),
            ocr_module.start(),
        )

    except Exception as e:
        logging.error(f"Error in main: {str(e)}")
        raise e

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('--enable-logging', action='store_true', help='Enable logging')
    args = parser.parse_args()

    asyncio.run(main(args.enable_logging))
