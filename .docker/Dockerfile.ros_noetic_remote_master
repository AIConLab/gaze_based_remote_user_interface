# Use the official ROS Noetic image as the base
FROM osrf/ros:noetic-desktop-full

# Install RViz and necessary packages for software rendering and debugging
RUN apt-get update && apt-get install -y \
    curl \
    gnupg2 \
    lsb-release \
    bash-completion \
    ros-${ROS_DISTRO}-image-transport-plugins \
    ros-${ROS_DISTRO}-teleop-twist-keyboard \
    ros-${ROS_DISTRO}-husky-* \
    python3-wstool \
    python3-rosdep \
    python3-rosinstall \
    python3-rosinstall-generator \
    python3-dev \
    python3-pip \
    libgl1-mesa-dri \
    libglvnd0 \
    libgl1 \
    libglx0 \
    libegl1 \
    libxext6 \
    libx11-6 \
    bash-completion \
    iputils-ping \
    net-tools \
    iproute2 \
    git \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Set up environment variables
ENV ROS_DISTRO noetic
ENV LIBGL_ALWAYS_SOFTWARE 1
ENV DISPLAY=:0

# Create catkin workspace and package directories
RUN mkdir -p /root/catkin_ws/src/ugv_mission_pkg/srv && \
    mkdir -p /root/catkin_ws/src/ugv_mission_pkg/msg
WORKDIR /root/catkin_ws/src/ugv_mission_pkg

# Copy service files
COPY ../app/mission_manager/srv/* ./srv/

# Copy the msg
COPY ../app/mission_manager/msg/* ./msg/

# Create message files
WORKDIR /root/catkin_ws/src/ugv_mission_pkg

# Create package.xml
RUN echo '<?xml version="1.0"?>\n\
<package format="2">\n\
  <name>ugv_mission_pkg</name>\n\
  <version>0.0.0</version>\n\
  <description>Mission package</description>\n\
  <maintainer email="temp@temp.com">temp</maintainer>\n\
  <license>BSD</license>\n\
  <buildtool_depend>catkin</buildtool_depend>\n\
  <build_depend>message_generation</build_depend>\n\
  <build_depend>std_msgs</build_depend>\n\
  <exec_depend>message_runtime</exec_depend>\n\
  <exec_depend>std_msgs</exec_depend>\n\
</package>' > package.xml

# Create CMakeLists.txt with proper message handling
RUN echo 'cmake_minimum_required(VERSION 3.0.2)\n\
project(ugv_mission_pkg)\n\
\n\
find_package(catkin REQUIRED COMPONENTS\n\
  message_generation\n\
  std_msgs\n\
)\n\
\n\
add_message_files(\n\
  FILES\n\
  GPS.msg\n\
  MissionWaypoint.msg\n\
)\n\
\n\
add_service_files(\n\
  FILES\n\
  mission_commands.srv\n\
  mission_states.srv\n\
  mission_file_transfer.srv\n\
  segmentation_file_transfer.srv\n\
)\n\
\n\
generate_messages(\n\
  DEPENDENCIES\n\
  std_msgs\n\
)\n\
\n\
catkin_package(\n\
  CATKIN_DEPENDS\n\
    message_runtime\n\
    std_msgs\n\
)' > CMakeLists.txt

# Build the workspace
WORKDIR /root/catkin_ws
RUN /bin/bash -c "source /opt/ros/noetic/setup.bash && catkin_make"

WORKDIR /root
COPY .docker/pip_requirements/ros_noetic_remote_master.txt /root/req.txt
RUN pip3 install -r /root/req.txt

# Create a script to update /etc/hosts and source ROS workspace
RUN echo '#!/bin/bash\n\
if [ ! -z "$ROBOT_IP" ]; then\n\
  echo "$ROBOT_IP $ROBOT_HOSTNAME" >> /etc/hosts\n\
fi\n\
source /root/catkin_ws/devel/setup.bash\n\
exec "$@"' > /update-hosts.sh && chmod +x /update-hosts.sh

# Set the script as the entry point
ENTRYPOINT ["/update-hosts.sh"]